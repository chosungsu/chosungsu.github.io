---
title: 'Leveraging future relationship reasoning for vehicle trajectory prediction'
date: '2025-04-09'
tags: ['multi-agent', 'paper review']
---

### Abstract

다중 에이전트 간의 상호 작용을 이해하는 것은 현실적인 차량 궤적 예측에 매우 중요합니다. 기존 방법들은 풀링(pooling), 어텐션(attention) 또는 그래프 기반 방법을 사용하여 관찰된 과거 에이전트 궤적에서 상호 작용을 추론하려고 시도했지만, 이는 확정론적 접근 방식에 의존합니다. 그러나 이러한 방법들은 미래에 발생할 수 있는 다양한 상호 작용을 예측할 수 없기 때문에 복잡한 도로 구조에서는 실패할 수 있습니다.

본 논문에서는 차선 정보를 사용하여 에이전트 간의 확률적 미래 관계를 예측하는 새로운 접근 방식을 제안합니다. 에이전트의 대략적인 미래 움직임을 얻기 위해, 우리 방법은 먼저 차량의 차선 수준 웨이포인트 점유 확률을 예측합니다. 그런 다음, 인접 차선을 통과하는 에이전트 쌍이 강하게 상호 작용할 것이라고 가정하여 각 에이전트 쌍에 대한 인접 차선 통과 시간 확률을 활용합니다. 확률 분포를 사용하여 상호 작용을 모델링하며, 이는 여러 가능한 미래 상호 작용을 허용합니다. 이 분포는 정답 미래 궤적에서 얻은 상호 작용의 사후 분포(posterior distribution)로부터 학습됩니다.

---

### Introduction

자율 주행의 안전을 위해서는 차량의 미래 궤적을 예측하는 것이 매우 중요합니다. 초기의 heuristic prediction model은 대상 차량의 과거 궤적만을 활용했습니다. 그러나 딥러닝의 출현과 함께 고정밀(HD) 지도와의 차량 관계, 주변 에이전트를 함께 고려하여 더 정확한 예측을 할 수 있게 되었습니다.

이전 연구들은 풀링, 멀티 헤드 어텐션 또는 시공간 그래프(spatio-temporal graph) 방식을 사용하여 주변 차량의 과거 궤적으로부터 상호 작용을 모델링했습니다. 하지만 우리는 이러한 방법들이 복잡한 도로 구조에서는 쉽게 실패한다는 것을 관찰했습니다. 과거 궤적에만 기반하여 에이전트 간의 미래 관계를 추론하는 것의 어려움이 부각되었고 도로 구조를 통합하면 추론 과정이 훨씬 쉬워질 것으로 판단하였습니다.

인간 운전자의 의사결정 과정은 상호 작용을 모델링하는 방법에 대한 통찰력을 제공할 수 있습니다. 그들은 먼저 지도에서 도달하려는 목표를 설정합니다. 다음으로, 주변 에이전트와의 상호 작용을 추론하기 위해 다른 에이전트가 미래에 어떻게 행동할지 대략적으로 추론합니다. 그 후, 다른 차량의 미래 경로가 자신의 경로와 겹칠 가능성을 추론함으로써 다른 에이전트와의 상호 작용을 추론합니다. 이렇듯 운전자들은 다른 차량의 미래 경로가 자신의 경로와 더 많이 겹칠수록 상호 작용이 더 중요하다고 간주합니다. 본 논문에서는 이 과정을 통해 얻은 상호 작용을 미래 관계(Future Relationship)라고 정의합니다.

제안하는 방법에서 에이전트 간의 상호작용은 edge로 표현되며 확률이 클수록 상호작용이 더 높을 것으로 판단합니다.

---

### Related work

#### 1. 목표 기반 궤적 예측

미래 궤적을 한 번에 예측하는 것은 어려운 과제입니다. 대신, 목표 조건부 예측(goal-conditional prediction)은 목표 후보를 샘플링한 다음, 그 목표를 조건으로 궤적을 예측하는 방식으로, 특히 장거리 예측 작업에서 최첨단 성능을 보여주며 유용하게 활용되고 있습니다 (Zhao et al. (2021); Gu et al. (2021); Phan-Minh et al. (2020); Chai et al. (2020); Zhang et al. (2021)).

궤적 공간을 앵커 세트로 양자화하는 CoverNet (Phan-Minh et al. (2020)) 및 MultiPath (Chai et al. (2020))는 주변 지도가 고려되지 않아 운전 불가능한 영역을 가로지르는 지도 무시 궤적(map-agnostic trajectories)을 생성하는 경우가 많습니다. TNT (Zhao et al. (2021))는 차선 중심선에서 샘플링된 목표 지점을 사용하고, GoalNet (Zhang et al. (2021))은 차선 세그먼트를 궤적 앵커로 사용합니다. 그러나 이전 방법들은 최종 목적지에 도달할 가능성이 무작위라고 가정하는 반면, 특정 목표 영역에 도달하기 위한 궤적이 단일 모드(unimodal)라고 가정합니다. 본 논문에서는 특정 목표 영역에 도달하기 위해 주변 차량과의 상호 작용으로 인해 궤적이 달라질 수 있는 내재된 불확실성(inherent uncertainty)을 가정합니다.

#### 2. 상호 작용 모델링

에이전트 간의 상호 작용을 고려하는 것은 사회적 인지 궤적을 예측하는 데 도움이 됩니다. 아주 초기 단계에서는 지역 영역에서 상호 작용 특징을 풀링(pooling)하여 상호 작용을 얻었습니다 (Deo & Trivedi (2018); Gupta et al. (2018)). 다른 연구에서는 어텐션 기반(Ngiam et al. (2022); Mercat et al. (2020); Vemula et al. (2018)) 또는 GNN 기반 방법(Carrasco et al. (2021); Cao et al. (2021); Zeng et al. (2021); Casas et al. (2020); Liang et al. (2020); Gao et al. (2020))을 통해 상호 작용을 얻으려고 시도했습니다. 그러나 대부분의 이전 방법에서는 에이전트 간의 상호 작용이 회귀 손실(regression loss)만으로 학습되었는데, 이는 동적이고 빠르게 변화하는 상황을 표현하기에는 불충분합니다.

#### 3. 다중 모드 궤적 예측

궤적 예측은 고유한 답이 아닌 여러 가지 가능한 미래가 존재하는 확률적 문제입니다. 최근에는 이 문제를 해결하기 위해 GAN (Goodfellow et al. (2014)) 또는 VAE (Kingma & Welling (2013))와 같은 심층 생성 모델이 사용되었습니다. 가장 밀접하게 관련된 GRIN (Li et al. (2021a))은 궤적 예측의 다중 모드성이 개인의 의도와 다른 에이전트와의 사회적 관계라는 두 가지 원천에서 비롯된다고 주장합니다. 그러나 GRIN은 과거 상호 작용만 고려하는 반면, 우리는 차량 움직임의 특성을 고려하여 미래 상호 작용을 고려할 것을 제안합니다.

---

### Formulation

각 장면에서 $N$개 차량의 과거 및 미래 궤적이 관찰됩니다. 과거 궤적은 $x_t^-$는 현재 시간 단계 이전의 $-t_p:0$ 시간 단계에 대한 위치로 구성됩니다. 미래 궤적 $x_t^+$는 현재 시간 단계 $t=0$ 이후의 $1:t_f$ 시간 단계에 대한 위치로 구성됩니다.

차선 정보는 HD 지도로 얻어지며 $M$개의 분할된 polyline으로 구성됩니다. $G=(l,e)$와 같이 그래프로 표현되고 여기서 노드$(l)$은 다른 차선 세그먼트에 해당하고 엣지$(e)$는 세그먼트 간의 관계를 나타냅니다. 세그먼트 간에 선행, 후행, 좌우 인접, 동일 교차로와 같이 5가지 관계가 있습니다. 확률 분포 $\tau_t$를 사용하여 예측된 차선 점유는 $\tau_t^-$, 정답 미래 차선 점유는 $\tau_t^+$로 표현됩니다.

---

### Method

우리의 초점은 에이전트 간의 "미래 관계(Future Relationship)"를 모델링하는 데 있습니다. 미래 관계를 추론하는 단순한 방법은 모든 미래 차량 궤적을 예측한 다음 그들 간의 유사성을 계산하는 것입니다. 그러나 이 방법은 예측을 두 번 수행해야 하므로 비효율적이고 중복적입니다. 본 논문에서는 차량이 주로 차선을 따른다는 아이디어에 영감을 받아 미래 관계 모델링에 차선 정보를 활용합니다. 우리의 핵심 아이디어는 두 차량이 인접한 차선을 통과할 것으로 예상될 경우, 미래에 상호 작용할 가능성이 높다는 것입니다.

#### 1. 웨이포인트 점유

<img src="https://velog.velcdn.com/images/devjo/post/287ee8ff-3b0a-4134-a38f-ed303e16e5c3/image.png" alt="Example Image" style="display: block; margin: 0 auto; height:200;" />

본 논문에서는 두 가지 웨이포인트 점유가 필요합니다. 하나는 과거 궤적에서 예측된 $\tau_t^-$이고 다른 하나는 상호 작용의 사전 및 사후 분포를 얻는 정답 $\tau_t^+$입니다.

과거 궤적에서 웨이포인트 점유를 예측하기 위해 과거 궤적 $x^-$과 차선 그래프 $G$를 차선 특징 $h_x^-, h_l$로 인코딩합니다.

$$
\tau_{1:t_l}^- = softmax(MLP([h_x^-, h_l])) \in R^{NMt_f}
$$

위 식과 같이 웨이포인트 점유를 예측합니다. 그 합은 1이 되도록 softmax를 적용합니다. GCN에 입력되고 근접도 $PR^-$를 얻습니다. 훈련 시에 정답 점유가 입력되어 가우시안 분포로 상호작용의 사후 분포를 얻게 됩니다.

#### 2. 미래 관계 모듈 (FRM)

에이전트 간 근접도 계산, 사후 분포 및 사전 분포 얻기. 차량의 중간 웨이포인트 점유(τ^{1:t_f−1})로부터 각 차량 쌍이 매 시간 단계마다 인접한 차선을 어떻게 통과하는지(에이전트 간 근접도)를 계산합니다. 그 정보와 에이전트의 과거 모션 특징을 기반으로 두 가지 상호 작용 분포를 얻습니다.

에이전트 간 근접도(PR)를 계산하기 위해, 먼저 그래프 컨볼루션 네트워크(GCN) (Welling & Kipf (2016))를 사용하여 웨이포인트 점유를 스무딩(smoothing)합니다. 이렇게 하는 이유는 차량이 특정 차선을 통과할 때, 반드시 동일한 차선이 아니라 인접한 차선을 통과하는 다른 차량에 영향을 미치기 때문입니다. 따라서 우리는 2-hop GCN 레이어를 사용하여 각 차선 연결(선행, 후행, 인접, 동일 교차로)에 대해 다른 스무딩을 적용합니다. 구체적으로, 각 레이어는 인접 차선으로부터 정보를 집계하고 비선형 변환을 적용합니다. 이를 통해 모델은 에이전트 간의 공간적 의존성을 포착하고 에이전트 간 근접도 계산의 정확도를 향상시킬 수 있습니다.

$$
\tilde{\tau^{1:t_f-1}}=\sum_{e \in {succ, pred, right, left, inter}} \sigma \\
*(D_e^{-1}A_e \tau^{1:t_f-1}W_e) \in R^{NM(t_f-1)}
$$

위 수식으로 스무딩된 웨이포인트 점유를 사용하여 에이전트 간 근접도를 구할 수 있습니다.

$$
PR=\tilde{\tau^{1:t_f-1}}*(\tilde{\tau^{1:t_f-1}})^T \in R^{NM(t_f-1)}
$$

사전 분포를 얻기 위해 과거 특징 $h_x^{-1}$과 근접도를 사용합니다. 상호작용 모델링은 다양하고 확률적인 속성을 반영해야 하고 모든 차량 쌍에서 발생하는 것을 포함합니다.

결과적으로 사전 분포는 각 에이전트 쌍에 대한 가우시안 혼합(GM)으로 정의가 되며 GMVAE에 따라 상호작용 엣지 $e^{ij}$를 d차원으로 $p_\theta(e|X) \sim \prod_K \pi_k N(\mu_k, I\sigma_k^2)$ 정의합니다. 이 매개변수들은 신경망으로 얻어집니다. 이후 두 샘플링 단계를 아래와 같이 진행합니다.

$$
k=\text{argmax}_k(\pi_k+g), \\
z_e^{-1}=\mu_k+\sigma_k \epsilon
$$

이제 사후 분포를 얻기 위해 웨이포인트 점유와 미래 특징을 사용합니다. 사전 분포와의 차이점은 사후 분포는 $\mu, \sigma = \{\mu_{ij}, \sigma_{ij}\}^{1:N,1:N}$ 와 같은 단일 가우시안으로 모델링된다는 것입니다.

#### 3. 학습

$$
ELBO=-E_{q_{\upsilon}}[log(p_{\theta}(Y|X, z_e, \tau))] \\
+ KL[q_{\upsilon}(z_e|X, \tau) | p_{\theta}(z_e|X, \tau)]
$$

정답 웨이포인트 점유 $\tau^+$를 사용할 수 있으므로 음의 로그우도 NLL을 사용하여 웨이포인트 점유 $\tau^-$를 예측하도록 학습합니다. 상호 엣지 $z_e$는 관찰 불가능하므로 CVAE를 사용하여 ELBO를 최적화합니다. 위 수식에서 $q_{\upsilon}$은 근사 사후 분포이고 $p_{\theta}$는 사전 분포입니다. 디코더가 학습 중에 엣지를 무시하는 degenerate 문제를 해결하기 위해 상호  작용 엣지의 역할을 순간적인 모션으로 제한하여 재구성 손실을 초래하도록 합니다.

$$
L_{nll}=-\tau^+log(\tau^-), \\
L_{KL}=-KL[q_{\upsilon}|p_{\theta}] \\
\approx log \sum_k \pi_k exp(-KL[q_{\upsilon}|p_{\theta,k}]), \\
L_{recon}=min_{z_e}\{E[log(p_{\theta}(Y|X, \tau^+))]\}
$$

위 세 손실의 합으로 전체 손실을 구성합니다.

---

### Conclusion

본 논문에서는 궤적 예측을 위해 차량 간의 상호 작용을 효과적으로 학습하는 미래 관계(Future Relationship) 개념을 제안했습니다. 과거 궤적 외에 차선 정보를 명시적으로 활용함으로써, 우리의 FRM(Future Relationship Module)은 복잡한 도로 구조에서도 적절한 상호 작용을 추론할 수 있습니다.

제안된 모델은 상호 작용을 확률적으로 얻어냄으로써 다양하면서도 사회적으로 타당한 궤적 샘플을 생성하며, 이는 웨이포인트 점유(waypoint occupancy) 또는 에이전트 간 근접도(inter-agent proximity)와 같은 설명 가능한 매개체를 제공합니다.

장거리 예측 작업인 nuScenes에서 최첨단(SoTA) 성능을 달성했으며, 단거리 예측 작업인 Argoverse에서도 놀라운 성능 향상을 가져왔습니다. Ye et al. (2022) 및 Zhou et al. (2022)와 같은 더 정교한 훈련 방법이나 GANet (Wang et al. (2022))과 같은 더 나은 기준 모델을 사용하면 예측 성능이 더욱 향상될 수 있을 것으로 기대합니다.

---

### 참고 자료

[원본 경로 #1](https://arxiv.org/pdf/2305.14715)



